# 詳細設計: Collector (論文収集)

## 1. 役割
`S2Collector` クラスは、Semantic Scholar (S2AG) API および ArXiv API を利用して、指定されたキーワードと Seed Paper を起点に関連論文を広範囲に収集する役割を担う。

## 2. 主要機能

### 2.1 キーワード検索 (`search_by_keywords`)
- **API:** `paper/search` エンドポイントを使用。
- **処理:** 指定された複数のキーワードをスペース区切りでクエリとして送信し、上位の論文（デフォルト100件）を取得する。
- **取得項目:** `title`, `year`, `citationCount`, `abstract`, `externalIds`, `url`。

### 2.2 スノーボールサンプリング (`get_related_papers`)
- **API:** `paper/DOI:<doi>` エンドポイントを使用。
- **処理:** 指定された DOI の論文の `references` (参考文献) と `citations` (被引用文献) を1階層取得する。
- **統合:** 取得した参考文献と被引用文献を一つのリストに統合して返す。

### 2.3 抄録補完 (`_fill_missing_abstracts_with_arxiv`)
- **背景:** S2AG では著作権等の理由でアブストラクトが取得できない場合がある。
- **API:** `arxiv` ライブラリ（ArXiv API）を使用。
- **アルゴリズム:**
    1. アブストラクトが空の論文を特定。
    2. タイトルまたは DOI で ArXiv を検索。
    3. ヒットした場合、タイトルの類似度を確認してアブストラクトを補完。
- **制約:** 1秒の `sleep` を挟むことでレート制限を回避。

### 2.4 初期収集 (`collect_initial`)
- **目的:** 最初のイテレーションのための候補論文セットを作成する。
- **処理:**
    1. キーワード検索 (`search_by_keywords`) を実行。
    2. Seed DOI が指定されている場合、その論文情報を取得 (`get_papers_by_dois`)。
    3. 両者をマージしたリストを返却。

### 2.5 スノーボール候補抽出 (`get_snowball_candidates`)
- **目的:** 次のイテレーションのために、有望な論文から探索範囲を広げる。
- **入力:** スコアリング済みの DataFrame, 上位 N 件指定 (`top_n`)。
- **処理:**
    1. `relevance_score` 上位 N 件の論文を抽出。
    2. 各論文の引用・被引用 (`get_related_papers`) を取得し、リスト化して返却。

### 2.6 統合プロセス処理 (`process_papers`)
- **目的:** 生の論文リストからクリーンでユニークな DataFrame を生成する。
- **処理:**
    1. **DOI抽出**: `externalIds` 等から DOI を特定。ないものは除外。
    2. **重複排除**:
        - 既知の DOI (`exclude_dois`) を除外。
        - 今回のバッチ内での重複を除外。
    3. **フィルタリング**:
        - `min_citations` 未満を除外。
        - `year_range` 区間外を除外。
    4. **補完**: ArXiv API を用いて欠損アブストラクトを補完。

## 3. 非機能仕様
- **エラーハンドリング:** `tenacity` を用いた指数バックオフによるリトライ（429 Rate Limit および 5xx エラー対象）。
- **ロギング:** 収集件数や API エラーの詳細を `review.collector` 階層のロガーに出力。
- **パフォーマンス:** 抽出効率向上のため、大量のリクエストが発生するスノーボール処理には丁寧なエラーハンドリングを実装。
